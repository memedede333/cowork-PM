<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>P√¥le Mission ‚Äî Brainstorming collaboratif (Firebase)</title>
  <style>
    *{box-sizing:border-box}
    :root{--primary:#2C3E50;--secondary:#3498DB;--accent:#E74C3C;--success:#27AE60;--warning:#F39C12;--bg:#f5f7fb;--card:#ffffff;--muted:#7F8C8D;--border:#E5E7EB;--shadow:0 10px 30px rgba(0,0,0,.06)}
    html,body{height:100%}
    body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);margin:0;color:var(--primary)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:16px;padding:18px;margin:12px 0;box-shadow:var(--shadow)}
    .header{position:relative;overflow:hidden}
    .header:before{content:"";position:absolute;inset:0;height:5px;background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent))}
    h1{margin:10px 0 4px;font-size:26px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
    label{font-size:13px}
    input,select,textarea{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;color:#fff;background:var(--primary);cursor:pointer;font-weight:600;transition:transform .05s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:var(--secondary)}
    .btn.success{background:var(--success)}
    .btn.warn{background:var(--warning)}
    .btn.ghost{background:#f3f4f6;color:var(--primary)}
    .grid{display:grid;gap:12px}
    .stats{grid-template-columns:repeat(3,1fr)}
    .stat{background:#fff;border-left:4px solid var(--secondary);padding:16px;border-radius:12px;text-align:center;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    .stat .v{font-size:26px;font-weight:800}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#eef2ff;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;color:#1f2937;font-size:12px}
    .session-badge{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:14px;padding:12px 16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .ideas{max-height:520px;overflow:auto}
    .idea{background:#f9fafb;border:1px solid var(--border);border-left:4px solid var(--secondary);border-radius:12px;padding:12px;margin:10px 0}
    .idea .meta{display:flex;justify-content:space-between;align-items:flex-start;font-size:12px;color:var(--muted)}
    .idea .content{margin:8px 0;white-space:pre-wrap;color:#111827}
    .idea.sel{outline:2px dashed var(--warning)}
    .mode{display:flex;gap:8px;background:#eef2ff;border-radius:12px;padding:6px}
    .mode .tab{flex:1;background:#fff;border:0;border-radius:8px;padding:10px;font-weight:600;cursor:pointer}
    .mode .tab.active{box-shadow:0 2px 10px rgba(0,0,0,.07)}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:var(--primary);color:#fff;padding:10px 18px;border-radius:999px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:999}
    .toast.success{background:var(--success)}
    .toast.warn{background:var(--warning)}
    .status{position:fixed;top:10px;right:10px;background:#fff;border-radius:999px;box-shadow:0 6px 16px rgba(0,0,0,.08);padding:8px 12px;display:flex;align-items:center;gap:8px;font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--success)}
    .dot.off{background:var(--accent)}
    @media (max-width:640px){.row{grid-template-columns:1fr}.stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="status"><span class="dot" id="dot"></span><span id="statusTxt">V√©rification‚Ä¶</span></div>
  <div class="container">
    <div class="card header">
      <h1>üéØ P√¥le Mission</h1>
      <div class="muted">Brainstorming collaboratif en temps r√©el (Firebase RTDB)</div>
    </div>

    <!-- Connexion / Cr√©ation de session -->
    <div class="card" id="loginCard">
      <h3 style="margin:0 0 12px">Rejoindre une session</h3>
      <form id="loginForm">
        <div class="grid">
          <div class="row"><label>Pr√©nom</label><input id="firstName" required/></div>
          <div class="row"><label>Nom</label><input id="lastName" required/></div>
          <div class="row"><label>Code session (vide = cr√©er)</label><input id="sessionInput" maxlength="6" style="text-transform:uppercase"/></div>
        </div>
        <div id="creatorOpts" class="card" style="margin-top:12px;display:none">
          <div class="muted" style="margin-bottom:6px">Cat√©gories</div>
          <div id="catTags" style="display:flex;flex-wrap:wrap;gap:8px">
            <span class="chip">G√©n√©ral</span>
            <span class="chip">Innovation</span>
            <span class="chip">Am√©lioration</span>
            <span class="chip">Probl√®me</span>
            <span class="chip">Solution</span>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px"><input id="newCat" placeholder="Nouvelle cat√©gorie"/><button type="button" class="btn secondary" id="addCat">Ajouter</button></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button class="btn" type="submit">üöÄ D√©marrer</button></div>
      </form>
    </div>

    <!-- Application -->
    <div id="app" style="display:none">
      <div class="session-badge">
        <div>
          <div style="font-weight:800;font-size:18px" id="sessionCode">‚Äî‚Äî‚Äî</div>
          <div class="muted">Code de session</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="chip"><span class="dot" style="width:6px;height:6px"></span> <span id="onlineCount">0</span> en ligne</div>
          <button id="logoutBtn" class="btn ghost">Se d√©connecter</button>
        </div>
      </div>

      <div class="grid stats">
        <div class="stat"><div class="v" id="statIdeas">0</div><div class="muted">Id√©es</div></div>
        <div class="stat"><div class="v" id="statParticipants">0</div><div class="muted">Participants</div></div>
        <div class="stat"><div class="v" id="statGroups">0</div><div class="muted">Groupes</div></div>
      </div>

      <div class="mode"><button class="tab active" data-mode="ideas">üí° Id√©es</button><button class="tab" data-mode="groups">üéØ Groupes</button><button class="tab" data-mode="participants">üë• Participants</button><button class="tab" data-mode="admin" id="adminTab" style="display:none">üõ°Ô∏è Admin</button></div>

      <!-- Id√©es -->
      <div id="ideasView">
        <div class="card">
          <h3 style="margin:0 0 10px">Ajouter une id√©e</h3>
          <form id="ideaForm">
            <div class="row"><label>Cat√©gorie</label><select id="category"></select></div>
            <div class="row"><label>Id√©e</label><textarea id="ideaText" placeholder="Votre id√©e‚Ä¶" required></textarea></div>
            <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn success" type="submit">üí° Partager</button></div>
          </form>
        </div>
        <div class="card" style="display:flex;gap:8px;align-items:center"><input id="search" placeholder="üîç Rechercher‚Ä¶"/><select id="filterCat"><option value="">Toutes cat√©gories</option></select><button id="groupBtn" class="btn warn" style="display:none">Cr√©er un groupe (‚â•2)</button></div>
        <div class="card"><h3 style="margin:0 0 12px">Flux d'id√©es</h3><div id="ideas" class="ideas"><p class="muted" style="text-align:center">Aucune id√©e‚Ä¶</p></div></div>
      </div>

      <!-- Groupes -->
      <div id="groupsView" style="display:none">
        <div class="card"><h3 style="margin:0 0 12px">Groupes</h3><div id="groups"></div></div>
      </div>

      <!-- Participants -->
      <div id="participantsView" style="display:none">
        <div class="card"><h3 style="margin:0 0 10px">Participants</h3><div id="participants" style="display:flex;flex-wrap:wrap;gap:8px"></div></div>
      </div>

      <!-- Admin (cr√©ateur) -->
      <div id="adminView" style="display:none">
        <div class="card">
          <h3 style="margin:0 12px 10px 0;display:flex;justify-content:space-between;align-items:center">Gestion de session
            <span class="chip" id="sessionStatus">active</span>
          </h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="archiveBtn" class="btn">Archiver la session</button>
            <button id="purgeBtn" class="btn warn">Supprimer la session</button>
          </div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 10px">Mod√©ration</h3>
          <div id="moderateList"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ==== CONFIG FIREBASE (ton projet) ====
    const firebaseConfig = {
      apiKey: "AIzaSyDRJzayhxMtvijL_944zMPtMEMU8zUXRaE",
      authDomain: "coworking-67676.firebaseapp.com",
      databaseURL: "https://coworking-67676-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "coworking-67676",
      storageBucket: "coworking-67676.appspot.com",
      messagingSenderId: "132701423535",
      appId: "1:132701423535:web:d10b9bc0f68bf089d0515a",
      measurementId: "G-79784W76EY"
    };

    // ==== IMPORTS SDK (modulaire) ====
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
    import {
      getDatabase, ref, push, set, get, update, remove,
      onValue, onChildAdded, onChildChanged, onChildRemoved,
      onDisconnect
    } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js';

    // ==== INIT ====
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ==== √âTAT ====
    const state = {
      me: null,            // {name, clientId, role}
      session: null,
      isCreator: false,
      categories: ['G√©n√©ral','Innovation','Am√©lioration','Probl√®me','Solution'],
      ideas: [],           // [{id, author, category, content, timestamp, groupId}]
      groups: [],          // [{id, name, ideaIds, createdBy, createdAt}]
      participants: {},    // {clientId: {name, online, joinedAt, lastSeen, role}}
      selected: new Set(),
      listeners: [],
      connected: false,
      status: 'active'
    };

    // ==== UTIL ====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const safe = s => (s||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    function toast(msg, kind='info'){ const t=document.createElement('div'); t.className=`toast ${kind==='success'?'success':kind==='warn'?'warn':''}`; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3200); }
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function deviceId(){ const k='pm:deviceId'; let v=localStorage.getItem(k); if(!v){ v='dev_'+uid()+uid(); localStorage.setItem(k,v);} return v; }

    // Presence indicator (SDK only, REST renvoie erreur sur /.info)
    onValue(ref(db,'/.info/connected'), s=>{ const ok=!!s.val(); state.connected=ok; $('#dot').classList.toggle('off',!ok); $('#statusTxt').textContent= ok? 'En ligne' : 'Hors-ligne'; });

    // === LOGIN FLOW ===
    $('#sessionInput').addEventListener('input', (e)=>{ const empty=!e.target.value.trim(); state.isCreator=empty; $('#creatorOpts').style.display= empty? 'block':'none'; });
    $('#addCat').addEventListener('click', ()=>{ const v=$('#newCat').value.trim(); if(!v) return; state.categories.push(v); const tag=document.createElement('span'); tag.className='chip'; tag.textContent=v; $('#catTags').appendChild(tag); $('#newCat').value=''; });

    $('#loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const first=$('#firstName').value.trim(); const last=$('#lastName').value.trim(); if(!first||!last) return;
      let code=$('#sessionInput').value.trim().toUpperCase(); if(!code){ state.isCreator=true; code=uid().toUpperCase(); }
      state.session = code;

      // Build name & identity
      const name = `${first} ${last}`;
      const cidKey = `pm:participant:${code}`;
      let cid = localStorage.getItem(cidKey);
      if(!cid) { cid = deviceId(); localStorage.setItem(cidKey, cid); }
      state.me = { name, clientId: cid, role: state.isCreator? 'creator':'participant' };

      // Categories si cr√©ateur
      if(state.isCreator){ const tags=$$('#catTags .chip').map(x=>x.textContent.trim()); if(tags.length) state.categories=tags; }

      // UI
      $('#loginCard').style.display='none'; $('#app').style.display=''; $('#sessionCode').textContent=code; populateCategories();

      await ensureSession();
      await upsertParticipant();
      attachRealtimeListeners();
      bindUIEvents();
      toast(`Bienvenue ${first} !`,'success');
    });

    function populateCategories(){ $('#category').innerHTML= state.categories.map(c=>`<option value="${c}">${c}</option>`).join(''); $('#filterCat').innerHTML= '<option value="">Toutes cat√©gories</option>'+ state.categories.map(c=>`<option value="${c}">${c}</option>`).join(''); }

    // === SESSION ===
    async function ensureSession(){
      const sRef = ref(db, `sessions/${state.session}`);
      const snap = await get(sRef);
      if(!snap.exists() && state.isCreator){
        await set(sRef, { sessionCode: state.session, createdAt: Date.now(), createdBy: state.me.name, categories: state.categories, status:'active', lastActivity: Date.now() });
      } else if(snap.exists()){
        const data = snap.val(); state.status = data.status||'active'; if(data.categories) state.categories=data.categories; populateCategories();
        if(data.ideas) state.ideas = Object.values(data.ideas);
        if(data.groups) state.groups = Object.values(data.groups);
        if(data.participants) state.participants = data.participants;
        renderIdeas(); renderGroups(); renderParticipants(); updateStats();
        if((data.createdBy||'')===state.me.name) state.isCreator=true; // si le cr√©ateur se reconnecte
      }
      if(state.isCreator) $('#adminTab').style.display='';
      $('#sessionStatus').textContent = state.status;
    }

    // === PARTICIPANTS (pr√©sence + mod√©ration) ===
    async function upsertParticipant(){
      const pRef = ref(db, `sessions/${state.session}/participants/${state.me.clientId}`);
      await set(pRef, { name: state.me.name, online: true, joinedAt: Date.now(), lastSeen: Date.now(), role: state.me.role });
      // Presence auto √† la d√©connexion
      onDisconnect(pRef).update({ online:false, lastSeen: Date.now() });
      update(ref(db, `sessions/${state.session}`), { lastActivity: Date.now() });
    }

    function renderParticipants(){
      const list = Object.entries(state.participants||{});
      const online = list.filter(([,p])=>p.online).length;
      $('#onlineCount').textContent = online;
      $('#statParticipants').textContent = list.length;
      $('#participants').innerHTML = list.map(([id,p])=>`<span class="chip" title="${id}">${safe(p.name)}${p.online?' ‚Ä¢':' (hors-ligne)'}${p.role==='creator'?' ‚Äî cr√©ateur':''}</span>`).join('');
      // Admin/mod√©ration list
      if(state.isCreator){
        $('#moderateList').innerHTML = list.map(([id,p])=>`
          <div class="idea" style="display:flex;justify-content:space-between;align-items:center">
            <div>${safe(p.name)} ${p.online?'‚Ä¢':''} <span class="muted">${id}</span></div>
            <div style="display:flex;gap:6px">
              ${id!==state.me.clientId?`<button class="btn warn" onclick="window._kick('${id}')">Retirer</button>`:''}
            </div>
          </div>`).join('');
      }
    }

    window._kick = async (id)=>{
      if(!state.isCreator) return;
      await remove(ref(db, `sessions/${state.session}/participants/${id}`));
      toast('Participant retir√©','success');
    }

    $('#logoutBtn').addEventListener('click', async ()=>{
      if(!state.me) return; await update(ref(db, `sessions/${state.session}/participants/${state.me.clientId}`), { online:false, lastSeen: Date.now() }); toast('D√©connect√©','success'); location.reload();
    });

    // === ID√âES ===
    $('#ideaForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const content=$('#ideaText').value.trim(); if(!content) return; const category=$('#category').value;
      const iRef = push(ref(db, `sessions/${state.session}/ideas`));
      const idea = { id:iRef.key, author:state.me.name, category, content, timestamp: Date.now(), groupId:null };
      await set(iRef, idea); $('#ideaText').value=''; update(ref(db,`sessions/${state.session}`),{ lastActivity: Date.now() }); toast('Id√©e ajout√©e !','success');
    });

    $('#search').addEventListener('input', renderIdeas); $('#filterCat').addEventListener('change', renderIdeas);

    function filteredIdeas(){
      const q=($('#search').value||'').toLowerCase(); const c=$('#filterCat').value; const arr = state.ideas.slice().sort((a,b)=>b.timestamp-a.timestamp);
      return arr.filter(i=>(!q || i.content.toLowerCase().includes(q) || i.author.toLowerCase().includes(q)) && (!c || i.category===c));
    }

    function renderIdeas(){
      const list = filteredIdeas();
      const container = $('#ideas');
      if(!list.length){ container.innerHTML = '<p class="muted" style="text-align:center">Aucune id√©e‚Ä¶</p>'; }
      else {
        container.innerHTML = list.map(i=>`
          <div class="idea ${state.selected.has(i.id)?'sel':''}" data-id="${i.id}">
            <div class="meta"><span><strong>${safe(i.author)}</strong></span><span class="chip">${safe(i.category)}</span></div>
            <div class="content">${safe(i.content)}</div>
            <div class="meta">
              <span>${new Date(i.timestamp).toLocaleString('fr-FR',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'})}</span>
              <span style="display:flex;gap:6px;align-items:center">
                <label class="chip"><input type="checkbox" ${state.selected.has(i.id)?'checked':''} onchange="window._sel('${i.id}',this.checked)"/> s√©lectionner</label>
                ${i.groupId?`<span class="chip">Groupe #${safe(i.groupId)}</span>`:''}
              </span>
            </div>
          </div>`).join('');
      }
      $('#statIdeas').textContent = state.ideas.length;
      $('#groupBtn').style.display = state.selected.size>=2 ? '' : 'none';
    }

    window._sel = (id,checked)=>{ if(checked) state.selected.add(id); else state.selected.delete(id); renderIdeas(); }

    $('#groupBtn').addEventListener('click', async ()=>{
      if(state.selected.size<2) return; const ids=[...state.selected];
      const gRef = push(ref(db, `sessions/${state.session}/groups`));
      const group = { id:gRef.key, name:`Groupe ${state.groups.length+1}`, ideaIds: ids, createdBy: state.me.name, createdAt: Date.now() };
      await set(gRef, group);
      // Marque chaque id√©e
      await Promise.all(ids.map(id=> update(ref(db, `sessions/${state.session}/ideas/${id}`), { groupId: group.id })));
      state.selected.clear(); toast('Groupe cr√©√©','success');
    });

    function renderGroups(){
      $('#statGroups').textContent = state.groups.length;
      const wrap = $('#groups');
      if(!state.groups.length){ wrap.innerHTML = '<p class="muted" style="text-align:center">Aucun groupe‚Ä¶</p>'; return; }
      wrap.innerHTML = state.groups.map(g=>{
        const gi = state.ideas.filter(i=> (g.ideaIds||[]).includes(i.id));
        return `<div class="idea"><div class="meta"><strong>${safe(g.name)}</strong><span class="muted">${gi.length} id√©es</span></div>
          <div style="margin-top:8px">${gi.map(i=>`<div class="chip" style="margin:4px 6px 0 0">${safe(i.content)}</div>`).join('')}</div></div>`;
      }).join('');
    }

    function updateStats(){ $('#statIdeas').textContent=state.ideas.length; $('#statGroups').textContent=state.groups.length; $('#statParticipants').textContent=Object.keys(state.participants||{}).length; }

    // === LISTENERS TEMPS R√âEL ===
    function attachRealtimeListeners(){
      state.listeners.forEach(u=>u&&u()); state.listeners=[];
      const base = `sessions/${state.session}`;
      // Id√©es
      const iRef = ref(db, `${base}/ideas`);
      state.listeners.push(onChildAdded(iRef, s=>{ const v=s.val(); if(!state.ideas.find(x=>x.id===v.id)){ state.ideas.push(v); renderIdeas(); renderGroups(); updateStats(); }}));
      state.listeners.push(onChildChanged(iRef, s=>{ const v=s.val(); const i=state.ideas.findIndex(x=>x.id===v.id); if(i>=0){ state.ideas[i]=v; renderIdeas(); renderGroups(); }}));
      state.listeners.push(onChildRemoved(iRef, s=>{ const v=s.val(); state.ideas=state.ideas.filter(x=>x.id!==v.id); renderIdeas(); renderGroups(); updateStats(); }));
      // Groupes
      const gRef = ref(db, `${base}/groups`);
      state.listeners.push(onValue(gRef, s=>{ const val=s.val()||{}; state.groups=Object.values(val); renderGroups(); updateStats(); }));
      // Participants
      const pRef = ref(db, `${base}/participants`);
      state.listeners.push(onValue(pRef, s=>{ state.participants=s.val()||{}; renderParticipants(); updateStats(); }));
      // Session status
      const sRef = ref(db, `${base}/status`);
      state.listeners.push(onValue(sRef, s=>{ state.status=s.val()||'active'; $('#sessionStatus').textContent=state.status; }));
    }

    // === ADMIN ===
    function bindUIEvents(){
      // Tabs
      $$('.mode .tab').forEach(b=>b.addEventListener('click', (e)=>{ $$('.mode .tab').forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); const m=e.currentTarget.dataset.mode; $('#ideasView').style.display= m==='ideas'? '' : 'none'; $('#groupsView').style.display= m==='groups'? '' : 'none'; $('#participantsView').style.display= m==='participants'? '' : 'none'; $('#adminView').style.display= m==='admin'? '' : 'none'; }));

      // Admin actions
      $('#archiveBtn')?.addEventListener('click', async ()=>{ if(!state.isCreator) return; await update(ref(db, `sessions/${state.session}`), { status:'archived', archivedAt: Date.now() }); toast('Session archiv√©e','success'); });
      $('#purgeBtn')?.addEventListener('click', async ()=>{ if(!state.isCreator) return; if(!confirm('Supprimer toute la session ?')) return; await remove(ref(db, `sessions/${state.session}`)); toast('Session supprim√©e','success'); location.reload(); });
    }
  </script>
</body>
</html>
