<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>P√¥le Mission ‚Äî Brainstorming collaboratif</title>
  <style>
    *{box-sizing:border-box} :root{--primary:#2C3E50;--secondary:#3498DB;--accent:#E74C3C;--success:#27AE60;--warning:#F39C12;--bg-light:#ECF0F1;--text-dark:#2C3E50;--text-light:#7F8C8D;--border:#BDC3C7;--shadow:rgba(0,0,0,.1)}
    body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);min-height:100vh;margin:0;padding:12px;color:var(--text-dark)}
    .container{max-width:780px;margin:0 auto}
    .card{background:#fff;border-radius:14px;padding:18px;margin:12px 0;box-shadow:0 8px 24px var(--shadow)}
    .app-header{padding:24px 18px;border-radius:18px;position:relative;overflow:hidden}
    .app-header::before{content:"";position:absolute;left:0;top:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent))}
    .h1{font-weight:800;font-size:24px;color:var(--primary);margin:0 0 6px}
    .muted{color:var(--text-light);font-size:13px}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
    label{font-size:13px;color:var(--text-dark)} input,select,textarea{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;background:var(--primary);color:#fff;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(.95)} .btn.secondary{background:var(--secondary)} .btn.success{background:var(--success)}
    .grid{display:grid;gap:12px} .grid.stats{grid-template-columns:repeat(3,1fr)} .stat{border-left:4px solid var(--secondary);text-align:center;padding:16px;border-radius:12px;background:#fff;box-shadow:0 4px 14px var(--shadow)}
    .stat .v{font-weight:800;font-size:26px;color:var(--primary)} .stat .l{font-size:12px;color:var(--text-light)}
    .session-badge{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:14px;padding:12px 16px;box-shadow:0 6px 18px var(--shadow)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:20px;background:var(--bg-light);font-size:12px}
    .ideas{max-height:460px;overflow:auto}
    .idea{background:var(--bg-light);border-left:4px solid var(--secondary);border-radius:12px;padding:12px;margin:10px 0}
    .idea .meta{display:flex;justify-content:space-between;align-items:flex-start;font-size:12px;color:var(--text-light)}
    .idea .content{margin:8px 0;white-space:pre-wrap}
    .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:10px 18px;border-radius:999px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:999}
    .toast.success{background:var(--success)} .toast.warn{background:var(--warning)}
    .status{position:fixed;top:10px;right:10px;background:#fff;border-radius:999px;box-shadow:0 6px 16px var(--shadow);padding:8px 12px;display:flex;align-items:center;gap:8px;font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--success)} .dot.off{background:var(--accent)}
  </style>
</head>
<body>
  <div class="status" id="status"><span class="dot" id="dot"></span><span id="statusText">V√©rification‚Ä¶</span></div>
  <div class="container">
    <div class="card app-header">
      <div class="h1">üéØ P√¥le Mission</div>
      <div class="muted">Brainstorming collaboratif en temps r√©el (Firebase Realtime Database)</div>
    </div>

    <!-- Connexion / Cr√©ation de session -->
    <div class="card" id="loginCard">
      <h3 style="margin:0 0 12px">Rejoindre une session</h3>
      <form id="loginForm">
        <div class="grid">
          <div class="row"><label>Pr√©nom</label><input id="firstName" required /></div>
          <div class="row"><label>Nom</label><input id="lastName" required /></div>
          <div class="row"><label>Code session (vide = cr√©er)</label><input id="sessionInput" maxlength="6" style="text-transform:uppercase" /></div>
        </div>
        <div id="creatorOptions" class="card" style="margin-top:12px;display:none">
          <div class="muted" style="margin-bottom:6px">Cat√©gories (cr√©ation de session)</div>
          <div id="catTags" style="display:flex;flex-wrap:wrap;gap:8px">
            <span class="chip">G√©n√©ral</span>
            <span class="chip">Innovation</span>
            <span class="chip">Am√©lioration</span>
            <span class="chip">Probl√®me</span>
            <span class="chip">Solution</span>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newCat" placeholder="Nouvelle cat√©gorie" />
            <button type="button" class="btn secondary" id="addCat">Ajouter</button>
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn" type="submit">üöÄ D√©marrer</button>
        </div>
      </form>
    </div>

    <!-- App principale -->
    <div id="app" style="display:none">
      <div class="session-badge">
        <div>
          <div style="font-weight:800;font-size:18px" id="sessionCode">‚Äî‚Äî‚Äî</div>
          <div class="muted">Code de session</div>
        </div>
        <div class="chip"><span class="dot" style="width:6px;height:6px"></span><span id="onlineCount">1</span> en ligne</div>
      </div>

      <div class="grid stats">
        <div class="stat"><div class="v" id="statIdeas">0</div><div class="l">Id√©es</div></div>
        <div class="stat"><div class="v" id="statParticipants">0</div><div class="l">Participants</div></div>
        <div class="stat"><div class="v" id="statGroups">0</div><div class="l">Groupes</div></div>
      </div>

      <!-- Ajout d'id√©e -->
      <div class="card">
        <h3 style="margin:0 0 10px">Ajouter une id√©e</h3>
        <form id="ideaForm">
          <div class="row"><label>Cat√©gorie</label><select id="category"></select></div>
          <div class="row"><label>Id√©e</label><textarea id="ideaText" placeholder="Votre id√©e‚Ä¶" required></textarea></div>
          <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn success" type="submit">üí° Partager l'id√©e</button></div>
        </form>
      </div>

      <!-- Filtres -->
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <input id="search" placeholder="üîç Rechercher‚Ä¶" />
        <select id="filterCat"><option value="">Toutes cat√©gories</option></select>
      </div>

      <!-- Flux d'id√©es -->
      <div class="card">
        <h3 style="margin:0 0 12px">Flux d'id√©es</h3>
        <div id="ideas" class="ideas"><p class="muted" style="text-align:center">Aucune id√©e pour le moment‚Ä¶</p></div>
      </div>

      <!-- Participants -->
      <div class="card">
        <h3 style="margin:0 0 10px">Participants</h3>
        <div id="participants" style="display:flex;flex-wrap:wrap;gap:8px"></div>
      </div>

      <!-- Exports -->
      <div class="card" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px">
        <button class="btn secondary" id="expJSON">üì• JSON</button>
        <button class="btn secondary" id="expCSV">üìä CSV</button>
        <button class="btn secondary" id="expTXT">üìù Texte</button>
        <button class="btn success" id="saveLocal">üíæ Sauvegarder localement</button>
      </div>
    </div>
  </div>

  <script type="module">
    // === CONFIG FIREBASE (harmonis√©e) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDRJzayhxMtvijL_944zMPtMEMU8zUXRaE",
      authDomain: "coworking-67676.firebaseapp.com",
      databaseURL: "https://coworking-67676-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "coworking-67676",
      storageBucket: "coworking-67676.appspot.com",
      messagingSenderId: "132701423535",
      appId: "1:132701423535:web:d10b9bc0f68bf089d0515a",
      measurementId: "G-79784W76EY"
    };

    // === IMPORTS FIREBASE (SDK modulaire) ===
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
    import {
      getDatabase, ref, push, set, update, remove, get,
      onValue, onChildAdded, onChildChanged, onChildRemoved
    } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js';

    // Initialisation (√©vite la double init)
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // === √âTAT APP ===
    const state = {
      me: null,
      session: null,
      isCreator: false,
      categories: ['G√©n√©ral','Innovation','Am√©lioration','Probl√®me','Solution'],
      ideas: [], // {id, author, category, content, timestamp}
      groups: [],
      participants: new Map(), // key -> name
      listeners: [],
      connected: false
    };

    // === UTIL ===
    const $ = s => document.querySelector(s);
    const elIdeas = $('#ideas');
    const elParticipants = $('#participants');
    const elCategory = $('#category');
    const elFilterCat = $('#filterCat');
    const elSessionCode = $('#sessionCode');
    const elStatIdeas = $('#statIdeas');
    const elStatParticipants = $('#statParticipants');
    const elStatGroups = $('#statGroups');
    function toast(msg, kind='info'){ const t=document.createElement('div'); t.className=`toast ${kind==='success'?'success':kind==='warn'?'warn':''}`; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3200); }
    const safe = s => s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));

    // === Indicateur connexion ===
    onValue(ref(db,'.info/connected'), snap => {
      const ok = !!snap.val(); state.connected = ok;
      $('#dot').classList.toggle('off', !ok);
      $('#statusText').textContent = ok ? 'En ligne' : 'Mode hors-ligne';
    });

    // === Login UI ===
    $('#sessionInput').addEventListener('input', e => {
      const empty = !e.target.value.trim();
      state.isCreator = empty;
      $('#creatorOptions').style.display = empty ? 'block' : 'none';
    });

    $('#addCat').addEventListener('click', () => {
      const v = $('#newCat').value.trim(); if(!v) return; state.categories.push(v);
      const tag = document.createElement('span'); tag.className='chip'; tag.textContent=v; $('#catTags').appendChild(tag); $('#newCat').value='';
    });

    $('#loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const first = $('#firstName').value.trim();
      const last  = $('#lastName').value.trim();
      let code    = $('#sessionInput').value.trim().toUpperCase();
      if(!first||!last) return;
      state.me = { fullName: `${first} ${last}` };
      if(!code){ state.isCreator = true; code = Math.random().toString(36).slice(2,8).toUpperCase(); }
      state.session = code;

      if(state.isCreator){
        const tags = Array.from(document.querySelectorAll('#catTags .chip')).map(x=>x.textContent.trim());
        if(tags.length) state.categories = tags;
      }

      $('#loginCard').style.display = 'none'; $('#app').style.display = '';
      elSessionCode.textContent = state.session;
      populateCategories();

      await ensureSession();
      await addParticipant();
      attachRealtimeListeners();
      toast(`Bienvenue ${first} !`, 'success');
    });

    function populateCategories(){
      elCategory.innerHTML = state.categories.map(c=>`<option value="${c}">${c}</option>`).join('');
      elFilterCat.innerHTML = '<option value="">Toutes cat√©gories</option>' + state.categories.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    // === Session ===
    async function ensureSession(){
      const sRef = ref(db, `sessions/${state.session}`);
      const snap = await get(sRef);
      if(!snap.exists() && state.isCreator){
        await set(sRef, {
          sessionCode: state.session,
          createdAt: new Date().toISOString(),
          createdBy: state.me.fullName,
          categories: state.categories
        });
        toast('‚úÖ Session cr√©√©e dans Firebase', 'success');
      } else if(snap.exists()){
        const data = snap.val();
        if(data.categories) state.categories = data.categories;
        populateCategories();
        if(data.ideas){ state.ideas = Object.values(data.ideas); renderIdeas(); }
        if(data.groups){ state.groups = Object.values(data.groups); renderGroups(); }
        if(data.participants){ state.participants = new Map(Object.entries(data.participants)); renderParticipants(); }
      }
      updateStats();
    }

    // === Participants ===
    async function addParticipant(){
      const pRef = push(ref(db, `sessions/${state.session}/participants`));
      await set(pRef, state.me.fullName);
    }
    function renderParticipants(){
      const arr = Array.from(state.participants.values());
      elParticipants.innerHTML = arr.map(n=>`<span class="chip">${safe(n)}</span>`).join('');
      $('#onlineCount').textContent = arr.length;
      elStatParticipants.textContent = arr.length;
    }

    // === Id√©es ===
    $('#ideaForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const content = $('#ideaText').value.trim(); if(!content) return;
      const category = $('#category').value;
      const iRef = push(ref(db, `sessions/${state.session}/ideas`));
      const idea = { id: iRef.key, author: state.me.fullName, category, content, timestamp: Date.now(), groupId: null };
      await set(iRef, idea);
      $('#ideaText').value = '';
      toast('Id√©e ajout√©e !','success');
    });

    function filteredIdeas(){
      const q = ($('#search').value||'').toLowerCase();
      const cat = $('#filterCat').value;
      return state.ideas.filter(i=>{
        const mQ = !q || i.content.toLowerCase().includes(q) || i.author.toLowerCase().includes(q);
        const mC = !cat || i.category===cat; return mQ && mC;
      }).sort((a,b)=>b.timestamp-a.timestamp);
    }

    function renderIdeas(){
      const list = filteredIdeas();
      if(!list.length){ elIdeas.innerHTML = '<p class="muted" style="text-align:center">Aucune id√©e‚Ä¶</p>'; }
      else {
        elIdeas.innerHTML = list.map(i=>`
          <div class="idea" data-id="${i.id}">
            <div class="meta"><span><strong>${safe(i.author)}</strong></span><span class="chip">${safe(i.category)}</span></div>
            <div class="content">${safe(i.content)}</div>
            <div class="meta"><span>${new Date(i.timestamp).toLocaleString('fr-FR',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'})}</span>
              ${i.groupId?`<span class="chip">Groupe #${safe(i.groupId)}</span>`:`<button class="btn secondary" style="padding:6px 10px" onclick="window._group('${i.id}')">Grouper</button>`}
            </div>
          </div>`).join('');
      }
      elStatIdeas.textContent = state.ideas.length;
    }

    window._group = async function(id){
      const gRef = push(ref(db, `sessions/${state.session}/groups`));
      const group = { id: gRef.key, name: `Groupe ${state.groups.length+1}`, ideaIds: [id], createdBy: state.me.fullName, createdAt: Date.now() };
      await set(gRef, group);
      const idx = state.ideas.findIndex(x=>x.id===id);
      if(idx>=0){ const ideaUpd = { ...state.ideas[idx], groupId: group.id }; await set(ref(db, `sessions/${state.session}/ideas/${id}`), ideaUpd); }
      toast('Groupe cr√©√©','success');
    }

    function renderGroups(){ elStatGroups.textContent = state.groups.length; }

    // === Listeners temps r√©el ===
    function attachRealtimeListeners(){
      state.listeners.forEach(u=>u&&u()); state.listeners = [];
      const iRef = ref(db, `sessions/${state.session}/ideas`);
      state.listeners.push(onChildAdded(iRef, s=>{ const v=s.val(); if(!state.ideas.find(x=>x.id===v.id)){ state.ideas.push(v); renderIdeas(); }}));
      state.listeners.push(onChildChanged(iRef, s=>{ const v=s.val(); const i=state.ideas.findIndex(x=>x.id===v.id); if(i>=0){ state.ideas[i]=v; renderIdeas(); }}));
      state.listeners.push(onChildRemoved(iRef, s=>{ const v=s.val(); state.ideas=state.ideas.filter(x=>x.id!==v.id); renderIdeas(); }));

      const pRef = ref(db, `sessions/${state.session}/participants`);
      state.listeners.push(onValue(pRef, s=>{ const val=s.val()||{}; state.participants=new Map(Object.entries(val)); renderParticipants(); }));

      const gRef = ref(db, `sessions/${state.session}/groups`);
      state.listeners.push(onValue(gRef, s=>{ const val = s.val()||{}; state.groups = Object.values(val); renderGroups(); }));
    }

    function updateStats(){
      elStatIdeas.textContent = state.ideas.length;
      elStatParticipants.textContent = state.participants.size || 0;
      elStatGroups.textContent = state.groups.length;
    }

    // Exports & local save ‚Äî (impl√©mentations minimales)
    $('#saveLocal').addEventListener('click', ()=>{
      const key = `brainstorming_${state.session}`;
      const payload = { session: state.session, ideas: state.ideas, groups: state.groups, participants: Array.from(state.participants.values()), categories: state.categories, ts: Date.now() };
      localStorage.setItem(key, JSON.stringify(payload)); toast('Sauvegard√© localement','success');
    });
    $('#expJSON').addEventListener('click', ()=>{
      const data = { session: state.session, ideas: state.ideas, groups: state.groups, participants: Array.from(state.participants.values()), categories: state.categories };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pole-mission-${state.session}.json`; a.click(); URL.revokeObjectURL(url);
    });
    $('#expCSV').addEventListener('click', ()=>{
      const headers = ['Auteur','Cat√©gorie','Id√©e','Groupe','Horodatage'];
      const rows = state.ideas.map(i=>[i.author,i.category,`"${(i.content||'').replace(/"/g,'""')}"`, i.groupId?`Groupe ${state.groups.find(g=>g.id===i.groupId)?.name||''}`:'', new Date(i.timestamp).toLocaleString('fr-FR')]);
      const csv = [headers,...rows].map(r=>r.join(',')).join('\n');
      const blob = new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pole-mission-${state.session}.csv`; a.click(); URL.revokeObjectURL(url);
    });
    $('#expTXT').addEventListener('click', ()=>{
      let text = `P√îLE MISSION ‚Äî EXPORT\nSession: ${state.session}\nDate: ${new Date().toLocaleString('fr-FR')}\nParticipants: ${Array.from(state.participants.values()).join(', ')}\nId√©es: ${state.ideas.length}\nGroupes: ${state.groups.length}\n\n`;
      state.ideas.forEach(i=>{ text += `‚Ä¢ [${i.category}] ${i.content} ‚Äî ${i.author} (${new Date(i.timestamp).toLocaleString('fr-FR')})\n`; });
      const blob = new Blob([text],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pole-mission-${state.session}.txt`; a.click(); URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
