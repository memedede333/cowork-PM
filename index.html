<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>P√¥le Mission - Brainstorming Collaboratif</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #2C3E50;
      --secondary: #3498DB;
      --accent: #E74C3C;
      --success: #27AE60;
      --warning: #F39C12;
      --bg-light: #ECF0F1;
      --bg-dark: #34495E;
      --text-dark: #2C3E50;
      --text-light: #7F8C8D;
      --border: #BDC3C7;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 10px;
      color: var(--text-dark);
    }

    .container { max-width: 600px; margin: 0 auto; }

    .app-header { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px var(--shadow); text-align: center; position: relative; overflow: hidden; }
    .app-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent)); animation: gradientShift 3s ease infinite; }
    @keyframes gradientShift { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(10px); } }
    .app-header h1 { font-size: 24px; color: var(--primary); margin-bottom: 8px; font-weight: 700; }
    .app-header p { color: var(--text-light); font-size: 14px; }

    .session-badge { background: var(--primary); color: white; padding: 12px 20px; border-radius: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.2); }
    .session-code { font-size: 18px; font-weight: bold; letter-spacing: 2px; }
    .live-indicator { display: flex; align-items: center; gap: 8px; }
    .live-dot { width: 8px; height: 8px; background: #27AE60; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px var(--shadow); animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 500; font-size: 14px; }

    input, textarea, select { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; transition: all 0.3s; background: white; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
    textarea { min-height: 100px; resize: vertical; font-family: inherit; }

    .btn { background: var(--primary); color: white; border: none; padding: 14px 25px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn:hover { background: var(--bg-dark); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(44, 62, 80, 0.3); }
    .btn-secondary { background: var(--secondary); }
    .btn-secondary:hover { background: #2980B9; }
    .btn-success { background: var(--success); }
    .btn-success:hover { background: #229954; }
    .btn-small { padding: 8px 16px; font-size: 13px; width: auto; }

    .category-manager { background: var(--bg-light); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .category-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .category-tag { background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    .category-tag button { background: none; border: none; color: white; cursor: pointer; font-size: 16px; padding: 0; margin: 0; line-height: 1; }

    .add-category-form { display: flex; gap: 8px; }
    .add-category-form input { flex: 1; padding: 8px 12px; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid var(--secondary); box-shadow: 0 3px 10px var(--shadow); }
    .stat-value { font-size: 28px; font-weight: bold; color: var(--primary); display: block; }
    .stat-label { font-size: 12px; color: var(--text-light); margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

    .ideas-container { max-height: 500px; overflow-y: auto; padding-right: 5px; }
    .ideas-container::-webkit-scrollbar { width: 5px; }
    .ideas-container::-webkit-scrollbar-track { background: var(--bg-light); border-radius: 10px; }
    .ideas-container::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 10px; }

    .idea-card { background: var(--bg-light); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--secondary); transition: all 0.3s; position: relative; }
    .idea-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px var(--shadow); }
    .idea-card.grouped { border-left-color: var(--accent); background: #FEF5E7; }
    .idea-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .idea-author { font-weight: 600; color: var(--primary); font-size: 14px; }
    .idea-category { background: var(--secondary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; text-transform: uppercase; }
    .idea-content { color: var(--text-dark); line-height: 1.6; margin-bottom: 10px; }
    .idea-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .idea-time { font-size: 11px; color: var(--text-light); }
    .idea-actions { display: flex; gap: 8px; }
    .group-btn { background: var(--warning); color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.3s; }
    .group-btn:hover { background: #E67E22; }

    .group-section { background: #FEF5E7; border: 2px dashed var(--warning); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
    .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .group-title { font-weight: 600; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }

    .participants-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .participant-tag { background: white; color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 13px; border: 2px solid var(--primary); }

    .filter-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-section input, .filter-section select { flex: 1; min-width: 150px; }

    .export-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 20px; }

    .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg-light); padding: 5px; border-radius: 10px; }
    .mode-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-dark); border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
    .mode-btn.active { background: white; box-shadow: 0 2px 8px var(--shadow); }

    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); animation: slideUpToast 0.5s ease; z-index: 1000; }
    .toast.success { background: var(--success); }
    .toast.warning { background: var(--warning); }
    @keyframes slideUpToast { from { opacity: 0; transform: translateX(-50%) translateY(50px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

    .connection-status { position: fixed; top: 10px; right: 10px; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 10px var(--shadow); display: flex; align-items: center; gap: 8px; font-size: 12px; z-index: 100; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
    .status-dot.offline { background: var(--accent); }

    .hidden { display: none; }

    @media (max-width: 480px) {
      .app-header h1 { font-size: 20px; }
      .stats-grid { grid-template-columns: 1fr; }
      .filter-section { flex-direction: column; }
      .export-section { grid-template-columns: 1fr; }
    }

    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="connection-status" onclick="showFirebaseInfo()">
    <span class="status-dot" id="statusDot"></span>
    <span id="statusText">V√©rification...</span>
  </div>

  <div class="container">
    <div class="app-header">
      <h1>üéØ P√¥le Mission</h1>
      <p>Brainstorming Collaboratif</p>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="card">
      <h2 style="margin-bottom: 20px; color: var(--primary);">Rejoindre une session</h2>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Pr√©nom</label>
          <input type="text" id="firstName" required>
        </div>
        <div class="form-group">
          <label>Nom</label>
          <input type="text" id="lastName" required>
        </div>
        <div class="form-group">
          <label>Code session (laisser vide pour cr√©er)</label>
          <input type="text" id="sessionInput" maxlength="6" style="text-transform: uppercase;">
        </div>

        <div id="sessionCreatorOptions" class="hidden">
          <div class="form-group">
            <label>‚öôÔ∏è Personnaliser les cat√©gories</label>
            <div class="category-manager">
              <div class="category-list" id="categoryList">
                <span class="category-tag">G√©n√©ral <button onclick="removeCategory(this)">√ó</button></span>
                <span class="category-tag">Innovation <button onclick="removeCategory(this)">√ó</button></span>
                <span class="category-tag">Am√©lioration <button onclick="removeCategory(this)">√ó</button></span>
                <span class="category-tag">Probl√®me <button onclick="removeCategory(this)">√ó</button></span>
                <span class="category-tag">Solution <button onclick="removeCategory(this)">√ó</button></span>
              </div>
              <div class="add-category-form">
                <input type="text" id="newCategory" placeholder="Nouvelle cat√©gorie">
                <button type="button" class="btn btn-small btn-secondary" onclick="addCategory()">+</button>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn">
          <span>üöÄ</span>
          <span>D√©marrer</span>
        </button>
      </form>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
      <div class="session-badge">
        <div>
          <div class="session-code" id="sessionCode">XXXXX</div>
          <small style="opacity: 0.9;">Code de session</small>
        </div>
        <div class="live-indicator" style="gap:12px">
          <span class="live-dot"></span>
          <span id="participantCount">1</span> en ligne
          <button id="logoutBtn" class="btn btn-small btn-secondary" style="width:auto">Se d√©connecter</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-value" id="totalIdeas">0</span>
          <span class="stat-label">Id√©es</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalParticipants">0</span>
          <span class="stat-label">Participants</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalGroups">0</span>
          <span class="stat-label">Groupes</span>
        </div>
      </div>

      <!-- Mode Selector -->
      <div class="mode-selector">
        <button class="mode-btn active" onclick="switchMode('ideas')">üí° Id√©es</button>
        <button class="mode-btn" onclick="switchMode('groups')">üéØ Groupes</button>
        <button class="mode-btn" onclick="switchMode('participants')">üë• Participants</button>
        <button id="adminTab" class="mode-btn hidden" onclick="switchMode('admin')">üõ°Ô∏è Admin</button>
      </div>

      <!-- Ideas Mode -->
      <div id="ideasMode">
        <div class="card">
          <h3 style="margin-bottom: 15px;">Ajouter une id√©e</h3>
          <form onsubmit="handleAddIdea(event)">
            <div class="form-group">
              <select id="category"></select>
            </div>
            <div class="form-group">
              <textarea id="ideaContent" placeholder="Votre id√©e..." required></textarea>
            </div>
            <button type="submit" class="btn btn-success"><span>üí°</span><span>Partager l'id√©e</span></button>
          </form>
        </div>

        <div class="filter-section">
          <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="filterIdeas()">
          <select id="filterCategory" onchange="filterIdeas()"></select>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 15px;">Flux d'id√©es</h3>
          <div id="ideasContainer" class="ideas-container">
            <p style="text-align: center; color: var(--text-light);">Aucune id√©e pour le moment...</p>
          </div>
        </div>
      </div>

      <!-- Groups Mode -->
      <div id="groupsMode" class="hidden">
        <div class="card">
          <h3 style="margin-bottom: 15px;">Groupes d'id√©es similaires</h3>
          <div id="groupsContainer">
            <p style="text-align: center; color: var(--text-light);">Aucun groupe cr√©√© pour le moment...</p>
          </div>
        </div>
      </div>

      <!-- Participants Mode -->
      <div id="participantsMode" class="hidden">
        <div class="card">
          <h3 style="margin-bottom: 15px;">Participants actifs</h3>
          <div id="participantsList" class="participants-list"></div>
        </div>
      </div>

      <!-- Admin Mode -->
      <div id="adminMode" class="hidden">
        <div class="card">
          <h3 style="margin-bottom: 12px; display:flex; justify-content:space-between; align-items:center;">Gestion de session
            <span id="sessionStatus" class="participant-tag" style="border-color:var(--secondary); color:var(--secondary);">active</span>
          </h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="archiveBtn" style="width:auto;">Archiver la session</button>
            <button class="btn btn-secondary" id="unarchiveBtn" style="width:auto;">R√©activer</button>
            <button class="btn" id="purgeBtn" style="width:auto; background: var(--accent);">Supprimer la session</button>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-bottom: 12px;">Mod√©ration des participants</h3>
          <div id="moderateList"></div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="export-section">
        <button onclick="exportJSON()" class="btn btn-secondary"><span>üì•</span><span>JSON</span></button>
        <button onclick="exportCSV()" class="btn btn-secondary"><span>üìä</span><span>CSV</span></button>
        <button onclick="exportText()" class="btn btn-secondary"><span>üìù</span><span>Texte</span></button>
        <button onclick="saveToLocalStorage()" class="btn btn-success"><span>üíæ</span><span>Sauvegarder</span></button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (modulaire) -->
  <script type="module">
    // Configuration Firebase pour P√¥le Mission (bucket corrig√©)
    const firebaseConfig = {
      apiKey: "AIzaSyDRJzayhxMtvijL_944zMPtMEMU8zUXRaE",
      authDomain: "coworking-67676.firebaseapp.com",
      databaseURL: "https://coworking-67676-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "coworking-67676",
      storageBucket: "coworking-67676.appspot.com",
      messagingSenderId: "132701423535",
      appId: "1:132701423535:web:d10b9bc0f68bf089d0515a",
      measurementId: "G-79784W76EY"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
    import {
      getDatabase, ref, push, set, get, onValue, onChildAdded, onChildChanged, onChildRemoved,
      update, remove, onDisconnect
    } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js';

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Expose pour le script non-module
    window.firebaseDB = { database, ref, push, set, get, onValue, onChildAdded, onChildChanged, onChildRemoved, update, remove, onDisconnect };
    console.log('‚úÖ Firebase connect√© avec succ√®s!');
  </script>

  <!-- App Logic -->
  <script>
    // ===== Helpers & State =====
    let appState = {
      currentUser: null,
      sessionCode: null,
      ideas: [],
      participants: new Map(), // clientId -> {name, online, role}
      groups: [],
      categories: ['G√©n√©ral','Innovation','Am√©lioration','Probl√®me','Solution'],
      isCreator: false,
      mode: 'ideas',
      connected: false,
      status: 'active'
    };
    let selectedIdeasForGroup = new Set();

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const escapeHtml = (t) => (t||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    const formatTime = ts => new Date(ts).toLocaleString('fr-FR',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
    function showToast(message, type='info'){ const toast=document.createElement('div'); toast.className=`toast ${type==='success'?'success':type==='warning'?'warning':''}`; toast.textContent=message; document.body.appendChild(toast); setTimeout(()=>toast.remove(), 4000); }

    function updateConnectionStatus(connected){ const dot=$('#statusDot'); const text=$('#statusText'); if(connected){ dot.classList.remove('offline'); text.textContent='En ligne'; } else { dot.classList.add('offline'); text.textContent='Mode local'; } }
    function deviceId(){ const k='pm:deviceId'; let v=localStorage.getItem(k); if(!v){ v='dev_'+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
    function clientIdFor(code){ const k=`pm:${code}:clientId`; let v=localStorage.getItem(k); if(!v){ v=deviceId(); localStorage.setItem(k,v);} return v; }

    // Normalise un code session √† 6 caract√®res alphanum (A‚ÄìZ/0‚Äì9)
    function normalizeSessionCode(s){
      return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6);
    }

    // G√©n√®re un code al√©atoire **de 6** caract√®res
    function generateSessionCode(){
      return normalizeSessionCode(Math.random().toString(36).toUpperCase()) || 'ABC123';
    }

    // Toggle cr√©ateur options
    $('#sessionInput').addEventListener('input', (e)=>{ const isEmpty = e.target.value.trim()===''; $('#sessionCreatorOptions').classList.toggle('hidden', !isEmpty); if(isEmpty) appState.isCreator=true; e.target.value = normalizeSessionCode(e.target.value); });

    // Presence (SDK only)
    const waitForSDK = setInterval(()=>{ if(window.firebaseDB){ clearInterval(waitForSDK); try{ const { database, ref, onValue } = window.firebaseDB; onValue(ref(database, '.info/connected'), s=>{ updateConnectionStatus(!!s.val()); }); }catch{} } }, 100);
    let selectedIdeasForGroup = new Set();

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const escapeHtml = (t) => (t||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    const formatTime = ts => new Date(ts).toLocaleString('fr-FR',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
    function showToast(message, type='info'){ const toast=document.createElement('div'); toast.className=`toast ${type==='success'?'success':type==='warning'?'warning':''}`; toast.textContent=message; document.body.appendChild(toast); setTimeout(()=>toast.remove(), 4000); }

    function updateConnectionStatus(connected){ const dot=$('#statusDot'); const text=$('#statusText'); if(connected){ dot.classList.remove('offline'); text.textContent='En ligne'; } else { dot.classList.add('offline'); text.textContent='Mode local'; } }
    function deviceId(){ const k='pm:deviceId'; let v=localStorage.getItem(k); if(!v){ v='dev_'+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
    function clientIdFor(code){ const k=`pm:${code}:clientId`; let v=localStorage.getItem(k); if(!v){ v=deviceId(); localStorage.setItem(k,v);} return v; }

    // Toggle cr√©ateur options
    $('#sessionInput').addEventListener('input', (e)=>{ const isEmpty = e.target.value.trim()===''; $('#sessionCreatorOptions').classList.toggle('hidden', !isEmpty); if(isEmpty) appState.isCreator=true; });

    // Presence (SDK only)
    const waitForSDK = setInterval(()=>{ if(window.firebaseDB){ clearInterval(waitForSDK); try{ const { database, ref, onValue } = window.firebaseDB; onValue(ref(database, '.info/connected'), s=>{ updateConnectionStatus(!!s.val()); }); }catch{} } }, 100);

    // Login
    async function handleLogin(event){
      event.preventDefault();
      const firstName = $('#firstName').value.trim();
      const lastName  = $('#lastName').value.trim();
      let sessionInput = normalizeSessionCode($('#sessionInput').value.trim());
      $('#sessionInput').value = sessionInput; // refl√®te la normalisation
      appState.currentUser = { firstName, lastName, fullName: `${firstName} ${lastName}`, joinedAt: Date.now() };

      if(!sessionInput){
        appState.isCreator = true;
        appState.sessionCode = generateSessionCode(); // **toujours 6**
        const tags = $$('#categoryList .category-tag').map(x=>x.textContent.replace('√ó','').trim());
        if(tags.length) appState.categories = tags;
        console.log('üìù Cr√©ation de la session:', appState.sessionCode);
      } else {
        if(sessionInput.length !== 6){ showToast('Le code session doit faire exactement 6 caract√®res (A‚ÄìZ/0‚Äì9).','warning'); return; }
        appState.isCreator = false;
        appState.sessionCode = sessionInput; // **toujours 6**
        console.log('üîó Connexion √† la session:', appState.sessionCode);
      }

      $('#loginSection').classList.add('hidden');
      $('#mainApp').classList.remove('hidden');
      $('#sessionCode').textContent = appState.sessionCode;

      populateCategories();
      updateStats();
      updateParticipantsList();

      await initializeRealtimeConnection();
      showToast(`Bienvenue ${firstName} !`, 'success');
    }
    window.handleLogin = handleLogin;

    function addCategory(){ const input=$('#newCategory'); const c=input.value.trim(); if(c && !appState.categories.includes(c)){ const tag=document.createElement('span'); tag.className='category-tag'; tag.innerHTML=`${c} <button onclick="removeCategory(this)">√ó</button>`; $('#categoryList').appendChild(tag); input.value=''; } }
    window.addCategory = addCategory;
    window.removeCategory = (btn)=> btn.parentElement.remove();

    function populateCategories(){ $('#category').innerHTML = appState.categories.map(cat=>`<option value="${cat}">${cat}</option>`).join(''); $('#filterCategory').innerHTML = '<option value="">Toutes cat√©gories</option>'+ appState.categories.map(cat=>`<option value="${cat}">${cat}</option>`).join(''); }

    async function handleAddIdea(event){
      event.preventDefault();
      const category = $('#category').value;
      const content  = $('#ideaContent').value.trim();
      if(!content) return;
      const { database, ref, push, set, update } = window.firebaseDB;
      const iRef = push(ref(database, `sessions/${appState.sessionCode}/ideas`));
      const idea = { id: iRef.key, author: appState.currentUser.fullName, category, content, timestamp: Date.now(), groupId: null };
      await set(iRef, idea);
      $('#ideaContent').value='';
      await update(ref(database, `sessions/${appState.sessionCode}`), { lastActivity: Date.now() });
      showToast('Id√©e ajout√©e !', 'success');
    }
    window.handleAddIdea = handleAddIdea;

    function renderIdeas(){
      const container = $('#ideasContainer');
      const search = ($('#searchInput')?.value||'').toLowerCase();
      const cat    = $('#filterCategory')?.value||'';
      const list = appState.ideas.slice().sort((a,b)=>b.timestamp-a.timestamp).filter(i=>
        (!search || i.content.toLowerCase().includes(search) || i.author.toLowerCase().includes(search)) && (!cat || i.category===cat)
      );
      if(!list.length){ container.innerHTML='<p style="text-align:center;color:var(--text-light);">Aucune id√©e trouv√©e...</p>'; return; }
      container.innerHTML = list.map(idea=>`
        <div class="idea-card ${idea.groupId?'grouped':''}" data-id="${idea.id}">
          <div class="idea-header"><span class="idea-author">${escapeHtml(idea.author)}</span><span class="idea-category">${escapeHtml(idea.category)}</span></div>
          <div class="idea-content">${escapeHtml(idea.content)}</div>
          <div class="idea-footer">
            <span class="idea-time">${formatTime(idea.timestamp)}</span>
            <div class="idea-actions">
              ${!idea.groupId? `<button class="group-btn" onclick="toggleIdeaForGrouping('${idea.id}')">Grouper</button>` : `<span style="font-size:11px;color:var(--warning);">Groupe #${idea.groupId}</span>`}
            </div>
          </div>
        </div>`).join('');
      updateStats();
    }

    function toggleIdeaForGrouping(id){
      if(selectedIdeasForGroup.has(id)) selectedIdeasForGroup.delete(id); else selectedIdeasForGroup.add(id);
      const card = document.querySelector(`[data-id="${CSS.escape(id)}"]`); if(card) card.classList.toggle('grouped');
      if(selectedIdeasForGroup.size>=2) createGroup();
    }
    window.toggleIdeaForGrouping = toggleIdeaForGrouping;

    async function createGroup(){
      const ids=[...selectedIdeasForGroup]; if(ids.length<2) return;
      const { database, ref, push, set, update } = window.firebaseDB;
      const gRef = push(ref(database, `sessions/${appState.sessionCode}/groups`));
      const group = { id:gRef.key, name:`Groupe ${appState.groups.length+1}`, ideaIds: ids, createdBy: appState.currentUser.fullName, createdAt: Date.now() };
      await set(gRef, group);
      await Promise.all(ids.map(id=> update(ref(database, `sessions/${appState.sessionCode}/ideas/${id}`), { groupId: group.id })));
      selectedIdeasForGroup.clear();
      showToast('Groupe cr√©√© !','success');
    }
    window.createGroup = createGroup;

    function renderGroups(){
      const container = $('#groupsContainer');
      if(!appState.groups.length){ container.innerHTML='<p style="text-align:center;color:var(--text-light);">Aucun groupe cr√©√© pour le moment...</p>'; return; }
      container.innerHTML = appState.groups.map(g=>{
        const gi = appState.ideas.filter(i=> (g.ideaIds||[]).includes(i.id));
        return `<div class="group-section">
          <div class="group-header">
            <div class="group-title"><span>üéØ</span><span>${escapeHtml(g.name)}</span><small style="color:var(--text-light);">(${gi.length} id√©es)</small></div>
            <small style="color:var(--text-light);">Par ${escapeHtml(g.createdBy||'')}</small>
          </div>
          <div class="ideas-container" style="max-height:200px;">
            ${gi.map(i=>`<div class="idea-card" style="margin-bottom:10px;"><div class="idea-author">${escapeHtml(i.author)}</div><div class="idea-content" style="font-size:13px;">${escapeHtml(i.content)}</div></div>`).join('')}
          </div>
        </div>`;
      }).join('');
      updateStats();
    }

    function updateStats(){ $('#totalIdeas').textContent=appState.ideas.length; $('#totalGroups').textContent=appState.groups.length; $('#totalParticipants').textContent=appState.participants.size||0; $('#participantCount').textContent=appState.participants.size||0; }

    function updateParticipantsList(){ const c=$('#participantsList'); c.innerHTML = Array.from(appState.participants.values()).map(p=>`<span class="participant-tag">${escapeHtml(p.name)}${p.online?' ‚Ä¢':''}${p.role==='creator'?' ‚Äî cr√©ateur':''}</span>`).join(''); }

    // Export & sauvegarde locale
    function getCategorySummary(){ const s={}; appState.ideas.forEach(i=>{ s[i.category]=(s[i.category]||0)+1; }); return s; }
    function getAuthorSummary(){ const s={}; appState.ideas.forEach(i=>{ s[i.author]=(s[i.author]||0)+1; }); return s; }
    function downloadFile(content, filename, type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast(`Export r√©ussi : ${filename}`,'success'); }

    function exportJSON(){ const data={ session:appState.sessionCode, exportDate:new Date().toISOString(), participants:Array.from(appState.participants.values()).map(p=>p.name), ideas:appState.ideas, groups:appState.groups, categories:appState.categories, summary:{ totalIdeas:appState.ideas.length, totalParticipants:appState.participants.size||0, totalGroups:appState.groups.length, ideasByCategory:getCategorySummary(), ideasByAuthor:getAuthorSummary() } }; downloadFile(JSON.stringify(data,null,2), `pole-mission-${appState.sessionCode}.json`, 'application/json'); }
    function exportCSV(){ const headers=['Auteur','Cat√©gorie','Id√©e','Groupe','Date/Heure']; const rows=appState.ideas.map(idea=>{ const group=appState.groups.find(g=> (g.ideaIds||[]).includes(idea.id)); return [idea.author, idea.category, '"'+(idea.content||'').replace(/"/g,'""')+'"', group?group.name:'', formatTime(idea.timestamp)]; }); const csv=[headers,...rows].map(r=>r.join(',')).join('
'); downloadFile('Ôªø'+csv, `pole-mission-${appState.sessionCode}.csv`, 'text/csv;charset=utf-8'); }
    function exportText(){ let text=`P√îLE MISSION - BRAINSTORMING COLLABORATIF
${'='.repeat(50)}

`; text+=`Session: ${appState.sessionCode}
Date d'export: ${new Date().toLocaleString('fr-FR')}
Participants (${appState.participants.size||0}): ${Array.from(appState.participants.values()).map(p=>p.name).join(', ')}
Total d'id√©es: ${appState.ideas.length}
Groupes cr√©√©s: ${appState.groups.length}

${'='.repeat(50)}
`; const byCat={}; appState.ideas.forEach(i=>{ (byCat[i.category]=byCat[i.category]||[]).push(i); }); text+=`
### ID√âES PAR CAT√âGORIE

`; for(const [cat,ideas] of Object.entries(byCat)){ text+=`
${cat.toUpperCase()} (${ideas.length} id√©es)
${'-'.repeat(30)}
`; ideas.forEach(i=>{ text+=`
‚Ä¢ ${i.content}
  Par: ${i.author} | ${formatTime(i.timestamp)}
`; }); } if(appState.groups.length){ text+=`

### GROUPES D'ID√âES SIMILAIRES

`; appState.groups.forEach(g=>{ text+=`
${g.name}
${'-'.repeat(30)}
`; const gi=appState.ideas.filter(i=> (g.ideaIds||[]).includes(i.id)); gi.forEach(i=>{ text+=`‚Ä¢ ${i.content} (${i.author})
`; }); }); } downloadFile(text, `pole-mission-${appState.sessionCode}.txt`, 'text/plain;charset=utf-8'); }

    function saveToLocalStorage(){
      const dataToSave={ sessionCode:appState.sessionCode, ideas:appState.ideas, participants:Array.from(appState.participants.values()).map(p=>p.name), groups:appState.groups, categories:appState.categories, lastUpdated:new Date().toISOString() };
      try{ localStorage.setItem(`brainstorming_${appState.sessionCode}`, JSON.stringify(dataToSave)); showToast('üíæ Sauvegard√© localement','success'); }catch(e){ console.warn('LocalStorage error', e); }
    }

    window.exportJSON=exportJSON; window.exportCSV=exportCSV; window.exportText=exportText; window.saveToLocalStorage=saveToLocalStorage; // non critique ici

    // Modes
    function switchMode(mode){ appState.mode=mode; $$('.mode-btn').forEach(b=>b.classList.remove('active')); const map={ideas:'Id√©es',groups:'Groupes',participants:'Participants',admin:'Admin'}; const btn=[...$$('.mode-btn')].find(b=>b.textContent.includes(map[mode])); if(btn) btn.classList.add('active'); $('#ideasMode').classList.toggle('hidden', mode!=='ideas'); $('#groupsMode').classList.toggle('hidden', mode!=='groups'); $('#participantsMode').classList.toggle('hidden', mode!=='participants'); $('#adminMode').classList.toggle('hidden', mode!=='admin'); if(mode==='groups') renderGroups(); }
    window.switchMode = switchMode;

    // Admin actions
    $('#archiveBtn').addEventListener('click', async()=>{ if(!appState.isCreator) return; const { database, ref, update } = window.firebaseDB; await update(ref(database, `sessions/${appState.sessionCode}`), { status:'archived', archivedAt: Date.now() }); showToast('Session archiv√©e','success'); });
    $('#unarchiveBtn').addEventListener('click', async()=>{ if(!appState.isCreator) return; const { database, ref, update } = window.firebaseDB; await update(ref(database, `sessions/${appState.sessionCode}`), { status:'active' }); showToast('Session r√©activ√©e','success'); });
    $('#purgeBtn').addEventListener('click', async()=>{ if(!appState.isCreator) return; if(!confirm('Supprimer d√©finitivement cette session ?')) return; const { database, ref, remove } = window.firebaseDB; await remove(ref(database, `sessions/${appState.sessionCode}`)); showToast('Session supprim√©e','success'); location.reload(); });

    // Logout
    $('#logoutBtn').addEventListener('click', async()=>{ const { database, ref, update } = window.firebaseDB; const cid=clientIdFor(appState.sessionCode); await update(ref(database, `sessions/${appState.sessionCode}/participants/${cid}`), { online:false, lastSeen: Date.now() }); location.reload(); });

    // Firebase realtime
    async function initializeRealtimeConnection(){
      if(!window.firebaseDB){ updateConnectionStatus(false); return; }
      const { database, ref, set, get, update, onValue, onChildAdded, onChildChanged, onChildRemoved, onDisconnect } = window.firebaseDB;
      const base = `sessions/${appState.sessionCode}`;
      const sRef = ref(database, base);
      const snap = await get(sRef);
      if(!snap.exists() && appState.isCreator){
        await set(sRef, { sessionCode: appState.sessionCode, createdAt: Date.now(), createdBy: appState.currentUser.fullName, categories: appState.categories, status:'active', lastActivity: Date.now() });
      } else if(snap.exists()){
        const data=snap.val(); appState.status=data.status||'active'; if(data.categories) appState.categories=data.categories; if(data.ideas) appState.ideas=Object.values(data.ideas); if(data.groups) appState.groups=Object.values(data.groups);
        if(data.participants){ appState.participants=new Map(Object.entries(data.participants).map(([id,p])=>[id, typeof p==='string'?{name:p,online:true}:{...p}])); }
        populateCategories(); renderIdeas(); renderGroups(); updateParticipantsList(); updateStats();
        if((data.createdBy||'')===appState.currentUser.fullName) appState.isCreator=true;
      }
      if(appState.isCreator) $('#adminTab').classList.remove('hidden');
      $('#sessionStatus').textContent = appState.status;

      // Participant presence
      const cid = clientIdFor(appState.sessionCode);
      const pRef = ref(database, `${base}/participants/${cid}`);
      await set(pRef, { name: appState.currentUser.fullName, online: true, role: appState.isCreator?'creator':'participant', joinedAt: Date.now(), lastSeen: Date.now() });
      onDisconnect(pRef).update({ online:false, lastSeen: Date.now() });

      // Ideas listeners
      const iRef = ref(database, `${base}/ideas`);
      onChildAdded(iRef, s=>{ const v=s.val(); if(!appState.ideas.find(x=>x.id===v.id)){ appState.ideas.push(v); renderIdeas(); }});
      onChildChanged(iRef, s=>{ const v=s.val(); const i=appState.ideas.findIndex(x=>x.id===v.id); if(i>=0){ appState.ideas[i]=v; renderIdeas(); }});
      onChildRemoved(iRef, s=>{ const v=s.val(); appState.ideas=appState.ideas.filter(x=>x.id!==v.id); renderIdeas(); });

      // Groups
      const gRef = ref(database, `${base}/groups`);
      onValue(gRef, s=>{ appState.groups = Object.values(s.val()||{}); renderGroups(); updateStats(); });

      // Participants
      const partsRef = ref(database, `${base}/participants`);
      onValue(partsRef, s=>{
        const obj=s.val()||{}; appState.participants=new Map(Object.entries(obj).map(([id,p])=>[id, typeof p==='string'?{name:p, online:true}:p]));
        updateParticipantsList(); updateStats();
        // Admin moderation list
        if(appState.isCreator){ $('#moderateList').innerHTML = Object.entries(obj).map(([id,p])=>`<div class="idea-card" style="background:#fff; border-left-color:var(--primary); display:flex;justify-content:space-between;align-items:center;">
          <div><strong>${escapeHtml(p.name||p)}</strong> ${p.online?'‚Ä¢':''} <small style="color:var(--text-light)">${id}</small></div>
          ${id!==clientIdFor(appState.sessionCode)? `<button class="group-btn" onclick="kickParticipant('${id}')">Retirer</button>`:''}
        </div>`).join(''); }
      });

      appState.connected=true; updateConnectionStatus(true);
    }

    async function kickParticipant(id){ if(!appState.isCreator) return; const { database, ref, remove } = window.firebaseDB; await remove(ref(database, `sessions/${appState.sessionCode}/participants/${id}`)); showToast('Participant retir√©','success'); }
    window.kickParticipant = kickParticipant;

    function showFirebaseInfo(){ const info = `\nFirebase Status:\n- SDK charg√©: ${!!window.firebaseDB ? '‚úÖ' : '‚ùå'}\n- Connect√©: ${appState.connected ? '‚úÖ' : '‚ùå'}\n- Session: ${appState.sessionCode || 'N/A'}\n- Mode: ${appState.isCreator ? 'Cr√©ateur' : 'Participant'}\n`; alert(info); }
    window.showFirebaseInfo = showFirebaseInfo;
  </script>
</body>
</html>
